{
    "collab_server" : "",
    "contents" : "---\ntitle: \"20160613meeting\"\nauthor: \"Chung Fu,Yang\"\ndate: \"2016年6月10日\"\noutput: \n  html_document:\n    theme: united\n    fig_width: 10\n    fig_height: 7.5\n    toc : true\n    toc_float:\n      collapsed: false\n      smooth_scroll: false\n--- \n\n```{r,echo=FALSE,,warning=FALSE,message=F,plotly=TRUE}\noptions('scipen'=100,'digits'=8)\nknitr::opts_chunk$set(comment=\"\",prompt=T,strip.white=F,warning=FALSE,message=F,echo=F,out.width ='750px',out.height = '750px') #fig.width = X\nlibrary(formattable)\nlibrary(googleVis)\nlibrary(highcharter)\nlibrary(ggplot2)\nlibrary(plyr)\nlibrary(dplyr)\nlibrary(dygraphs)\nlibrary(ggmap)\nlibrary(data.table)\nlibrary(devtools)\nlibrary(plotly)\nlibrary(rCharts)\nlibrary(tidyr)\nlibrary(DT)\nlibrary(RColorBrewer)\nlibrary(stringr)\nlibrary(data.table)\nlibrary(rgeos)\nlibrary(maptools)\nlibrary(RCurl)\nlibrary(car)\nlibrary(grid)\nlibrary(rgdal)\nlibrary(RJDBC)\nlibrary(cowplot)\ntheme_clean <- function(base_size = 12) { \n  require(grid) # Needed for unit() function\n  theme_grey(base_size) %+replace%\ntheme(\n  axis.title = element_blank(),\n  axis.text = element_blank(), \n  panel.background = element_blank(),\n  panel.grid = element_blank(), \n  axis.ticks.length = unit(0, \"cm\"), \n  axis.ticks.margin = unit(0, \"cm\"),\n  panel.margin = unit(0, \"lines\"), \n  plot.margin = unit(c(0, 0, 0, 0), \"lines\"), \n  complete = TRUE) }\n###############\n  multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {\n    library(grid)\n    \n    # Make a list from the ... arguments and plotlist\n    plots <- c(list(...), plotlist)\n    \n    numPlots = length(plots)\n    \n    # If layout is NULL, then use 'cols' to determine layout\n    if (is.null(layout)) {\n      # Make the panel\n      # ncol: Number of columns of plots\n      # nrow: Number of rows needed, calculated from # of cols\n      layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),\n                       ncol = cols, nrow = ceiling(numPlots/cols))\n    }\n    \n    if (numPlots==1) {\n      print(plots[[1]])\n      \n    } else {\n      # Set up the page\n      grid.newpage()\n      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))\n      \n      # Make each plot, in the correct location\n      for (i in 1:numPlots) {\n        # Get the i,j matrix positions of the regions that contain this subplot\n        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))\n        \n        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,\n                                        layout.pos.col = matchidx$col))\n      }\n    }\n  }\n科別 = read.csv(\"科別欄位專用.csv\",header = T,fileEncoding = 'big5')\n## 用R載入JDBC的驅動程式，讓我們可以透過第三方驅動程式連線至SQL Server\ndrv <- JDBC(\"com.microsoft.sqlserver.jdbc.SQLServerDriver\",\n\t\t\"/Users/apple/Downloads/sqljdbc_4.2/cht/sqljdbc42.jar\")\n## 登入112的伺服器 打使用者帳號與密碼\ncon <- dbConnect(drv,\n\t\t\tpaste0(\"jdbc:sqlserver://\", '140.119.80.112:1434'),\n\t\t\t'test', 'aaa')    \n```\n\n\n## 各地區護理人員的年齡結構\n\n### 年齡**平均**與**標準差**\n\n\n各地區護理人員平均年齡在2008年至2012年有著明顯的上升趨勢，尤其是以**東部地區**最為明顯，年齡標準差的部分在2008年至2012年普遍沒有太大的變化，但是**離島地區**變異程度卻與醫師的年齡結構一樣變異明顯較大！\n\n* 平均年齡差異最大為：\n    + 東部地區、中部地區與離島地區\n* 標準差差異最大為：\n    + 離島地區\n\n根據此現象推論東部地區平均年齡差異大但變異程度小意味著台東地區年齡結構應該呈現高齡化護理人員，而離島地區平均年齡差異較大且變異程度最大，與離島地區醫師的年齡結構類似，是否為分佈在年輕與老年的護理人員極端導致變異程度大？分析如下：\n\n```{r}\n## 讀檔與資料命名\ntemp = read.csv(\"PHN.csv\",header=T)\ntemp$year = as.factor(temp$year)\ntemp %>% mutate(PRSN_SEX=gsub(\"F   \",\"F\",temp$PRSN_SEX)) -> temp\ntemp %>% mutate(PRSN_SEX=gsub(\"M   \",\"M\",temp$PRSN_SEX)) -> temp\ncolnames(temp)[14:16]=c(\"五齡組_old\",\"area\",\"五齡組_new\")\n## 平均年齡 ##\ntemp %>% filter(year==\"2008\")  %>% group_by(area) %>% summarise(`2008`=round(mean(AGE),2)) %>% left_join(temp %>% filter(year==\"2012\")  %>% group_by(area) %>%  summarise(`2012`=round(mean(AGE),2)),by='area') %>% gather(年度,平均年齡,2:3)-> temp_t\ntemp_t$area = factor(temp_t$area,levels=c(\"北部地區\",\"中部地區\",\"南部地區\",\"東部地區\",\"離島地區\"))\ntemp_t %>% \nggplot(aes(x=area,y=平均年齡,fill=年度))+geom_bar(stat=\"identity\",position=\"dodge\")+theme_bw(base_family=\"STHeiti\")+coord_cartesian(ylim = c(30,38))+\n  scale_fill_brewer(palette =\"Set1\")+labs(title =\"各地區平均年齡\", x = \"地區\", y = \"平均年齡\")+geom_text(aes(label = 平均年齡, x = area, y = 平均年齡), position = position_dodge(width = 0.8), vjust = -0.6,color=\"black\")+theme(axis.text.x=element_text(angle =0 ,size=15),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=20),plot.title = element_text(size = rel(1.5))) -> a\n```\n\n```{r}\n## 年齡標準差 ##\ntemp %>% filter(year==\"2008\")  %>% group_by(area) %>% summarise(`2008`=round(sd(AGE),2)) %>% left_join(temp %>% filter(year==\"2012\")  %>% group_by(area) %>%  summarise(`2012`=round(sd(AGE),2)),by='area') %>% gather(年度,年齡標準差,2:3) -> temp_t\ntemp_t$area = factor(temp_t$area,levels=c(\"北部地區\",\"中部地區\",\"南部地區\",\"東部地區\",\"離島地區\"))\ntemp_t  %>% \n  ggplot(aes(x=area,y=年齡標準差,fill=年度))+geom_bar(stat=\"identity\",position=\"dodge\")+theme_bw(base_family=\"STHeiti\")+coord_cartesian(ylim = c(7,11))+geom_text(aes(label = 年齡標準差, x = area, y = 年齡標準差), position = position_dodge(width = 0.8), vjust = -0.6,color=\"black\")+scale_fill_brewer(palette =\"Set1\")+labs(title =\"各地區年齡標準差\", x = \"地區\", y = \"年齡標準差\")+theme(axis.text.x=element_text(angle =0 ,size=15),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=20),plot.title = element_text(size = rel(1.5)))->b\n```\n\n```{r}\nplot_grid(a,b, ncol = 1, nrow = 2)\n```\n\n```{r}\ntemp_d = data.frame(地區=c(\"北部地區\",\"中部地區\",\"南部地區\",\"東部地區\",\"離島地區\"),平均年齡差異=c(0.49,1.03,0.73,1.39,0.97))\ntemp_d %>% arrange(desc(平均年齡差異)) %>% datatable()\n#temp_d %>% ggplot(aes(x=reorder(地區,desc(平均年齡差異)),y=平均年齡差異))+geom_bar(stat=\"identity\",position=\"dodge\")+theme_bw(base_family=\"STHeiti\")\n```\n\n\n## 離島地區\n\n###年齡結構\n\n由離島地區的五齡組年齡結構可以知道，25歲~29歲、30歲~34歲為兩個主要的分佈年齡層佔了總護理人員的五成以上，其中明顯可看出20歲~24歲年齡層比例有明顯的下降，根據相關資料推論應該與護士與護理師之間的制度與考試規定相關。而在2008年與2012年之間年齡結構的變化例如：25歲～29歲比例上升、35歲～39遂比例下降、40歲～44歲的比例下降、50歲～54歲與55歲～59等年齡層亦下降，是否與疲勞轟炸、惡性打壓、工作量過大等議題相關使得高齡護理人員越來越少？！\n\n```{r}\n#### 離島地區年齡結構  ####\ntemp %>% filter(year==\"2008\") %>% filter(area==\"離島地區\") %>% group_by(五齡組_new) %>% summarise(人數=length(PRSN_ID)) %>% mutate(`2008`=round(人數/sum(人數),2)) -> temp_08\ntemp %>% filter(year==\"2012\") %>% filter(area==\"離島地區\") %>% group_by(五齡組_new) %>% summarise(人數=length(PRSN_ID)) %>% mutate(`2012`=round(人數/sum(人數),2)) -> temp_12\ncolnames(temp_08)[1]=\"age\"\ncolnames(temp_12)[1]=\"age\"\ntemp_08 %>% left_join(temp_12,by='age') %>% mutate(人數.y=ifelse(is.na(人數.y),0,人數.y),比例.y=ifelse(is.na(`2012`),0,`2012`)) -> temp_0812\ntemp_0812 %>% \n  select(1,3,5) %>% \n  gather(年度,比例,2:3) %>%  \n  ggplot(aes(x=age,y=比例,group=年度,color=年度))+geom_line()+theme_bw(base_family=\"STHeiti\")+geom_text(aes(label = 比例, x = age, y = 比例), position = position_dodge(width = 0.8), vjust = -0.6,color=\"black\")\n\n#### highchart  ####\ntemp_0812 %>% select(1,3,5) %>% gather(年度,比例,2:3) -> temp_t\ntemp_t %>% filter(年度==\"2008\") %>% select(1,3) %>% mutate(比例=100*比例)-> temp_t8\ntemp_t %>% filter(年度==\"2012\") %>% select(1,3) %>% mutate(比例=ifelse(is.na(比例),0,100*比例)) -> temp_t12\nhighchart() %>% hc_xAxis(categories = temp_t12$age) %>% \n  hc_add_series(name = \"2008各年齡層比例\", data = temp_t8$比例) %>% \n  hc_add_series(name = \"2012各年齡層比例\", data = temp_t12$比例) %>% \n  hc_title(text = \"2008年與2012年各年齡層離島護理人員分佈比例\",\n           margin = 20, align = \"center\",\n           style = list(color = \"black\", useHTML = TRUE)) %>%\n# hc_title(text = \"2005年與2012年<i>各年齡層</i>醫師人口分佈<b>比例</b>\",margin = 20, align = \"center\",style = list(color = \"black\", useHTML = TRUE))\n  hc_subtitle(text = \"\",\n              align = \"center\",\n              style = list(color = \"#2b908f\", fontWeight = \"bold\")) %>% \n  #hc_credits(enabled = TRUE, # add credits\n   #          text = \"www.lonk.tomy.site\",\n  #           href = \"http://jkunst.com\") %>% \n  hc_legend(align = \"center\", verticalAlign = \"\",\n            layout = \"vertical\", x = 0, y = 100) %>%\n  hc_exporting(enabled = TRUE) %>%  # enable exporting option \n#  hc_tooltip(pointFormat = \"{point.y}%\") %>%  \n  hc_tooltip(crosshairs = TRUE, backgroundColor = \"#FCFFC5\",\n             shared = TRUE, borderWidth = 5) %>% hc_add_theme(hc_theme_sandsignika()) %>% \n  hc_yAxis(title = list(text = \"percentage\"),\n           labels = list(format = \"{value}%\"), max = 50) \n```\n\n\n### 遷出分析\n\n由離島遷出的護理人員將近五成往南部地區;四成往北部地區，而近八成的遷出人數集中於20歲至29歲，含蓋兩個五齡組，而另一方面可發現並無44歲以上的五齡組遷出的比例，由此可知44遂以幾乎沒有護理人員遷出，間接的推論是否護理人員在44歲以後便逐漸走下坡或是轉換跑道。\n\n\n```{r}\n### \ntemp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') %>% filter(is.na(area.x)!=TRUE) %>% filter(is.na(area.y)!=TRUE) %>% group_by(area.x,area.y) %>% summarise(人數=length(PRSN_ID))  %>% filter(area.x==\"離島地區\"&area.y!=\"離島地區\") %>% mutate(比例=100*round((人數/sum(人數)),2)) -> temp_out\n###\ntemp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') %>% filter(is.na(area.x)!=TRUE) %>% filter(is.na(area.y)!=TRUE) %>% group_by(area.x,area.y,五齡組_new.x) %>% summarise(人數=length(PRSN_ID))  %>% filter(area.x==\"離島地區\"&area.y!=\"離島地區\") %>% group_by(五齡組_new.x) %>% summarise(人數_new=sum(人數)) %>% mutate(比例=100*round(人數_new/sum(人數_new),2)) -> temp_out_a\n######\nhighchart() %>% \n  hc_title(text = \"2008年至2012年護理人員遷出各地區所佔比例\") %>%\n  hc_subtitle(text = \"護理人員遷出各年齡層所佔比例\") %>% \n  hc_add_series_labels_values(temp_out_a$五齡組_new.x, temp_out_a$比例, name = \"五齡組_new.x\",\n                              colorByPoint = TRUE, type = \"column\",dataLabels = list(enabled = FALSE)) %>% hc_add_series_labels_values(temp_out$area.y, temp_out$比例,\n                              colors = c(\"#3A6FE0\",\"#F06C80\",\"#459E45\",\"#D6B73A\"), type = \"pie\",\n                              name = \"type\", colorByPoint = TRUE, center = c('70%', '35%'),\n                              size = 190, dataLabels = list(enabled = TRUE))%>% \n  hc_yAxis(title = list(text = \"percentage\"),\n           labels = list(format = \"{value}%\"), max = 60) %>% \n  hc_xAxis(categories = temp_out_a$五齡組_new.x) %>% \n  hc_legend(enabled = FALSE)  %>% \nhc_tooltip(pointFormat = \"{point.y}%\") %>%\n  hc_exporting(enabled = TRUE)\n#%>% hc_credits(enabled = TRUE, text = \"Source: HIMYM\",\n#            href = \"https://www.youtube.com/watch?v=f_J8QU1m0Ng\",\n#             style = list(fontSize = \"12px\"))\n```\n\n### 遷入分析\n\n各地區遷入比例圓餅圖可明顯看出五成嵌入離島地區的護理人員來自北部地區，南部及中部則各佔二成多左右，主要遷入人口多分佈於20歲～24歲與25歲～29歲為主要遷入比例(約近七成)。\n\n\n```{r}\ntemp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') %>% filter(is.na(area.x)!=TRUE) %>% filter(is.na(area.y)!=TRUE) %>% group_by(area.x,area.y) %>% summarise(人數=length(PRSN_ID))  %>% filter(area.x!=\"離島地區\"&area.y==\"離島地區\") %>% mutate(比例=100*round(人數/50,2)) -> temp_in\n\ntemp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') %>% filter(is.na(area.x)!=TRUE) %>% filter(is.na(area.y)!=TRUE) %>% group_by(area.x,area.y,五齡組_new.x) %>% summarise(人數=length(PRSN_ID))  %>% filter(area.x!=\"離島地區\"&area.y==\"離島地區\") %>% group_by(五齡組_new.x) %>% summarise(人數_new=sum(人數)) %>% mutate(比例=100*round(人數_new/sum(人數_new),2)) -> temp_in_a\n####\n\n######\nhighchart() %>% \n  hc_title(text = \"2008年至2012年護理人員各地區遷入所佔比例\") %>%\n  hc_subtitle(text = \"護理人員遷入各年齡層所佔比例\") %>% \n  hc_add_series_labels_values(temp_in_a$五齡組_new.x, temp_in_a$比例, name = \"五齡組_new.x\",\n                              colorByPoint = TRUE, type = \"column\",dataLabels = list(enabled = FALSE)) %>% hc_add_series_labels_values(temp_in$area.x, temp_in$比例,\n                              colors = c(\"#3A6FE0\",\"#F06C80\",\"#459E45\",\"#D6B73A\"), type = \"pie\",\n                              name = \"type\", colorByPoint = TRUE, center = c('70%', '35%'),\n                              size = 190, dataLabels = list(enabled = TRUE))%>% \n  hc_yAxis(title = list(text = \"percentage\"),\n           labels = list(format = \"{value}%\"), max = 60) %>% \n  hc_xAxis(categories = temp_in_a$五齡組_new.x) %>% \n  hc_legend(enabled = FALSE)  %>% \nhc_tooltip(pointFormat = \"{point.y}%\") %>%\n  hc_exporting(enabled = TRUE)\n#%>% hc_credits(enabled = TRUE, text = \"Source: HIMYM\",\n#            href = \"https://www.youtube.com/watch?v=f_J8QU1m0Ng\",\n#             style = list(fontSize = \"12px\"))\n```\n\n## 遷移熱圖(2008～2012)\n\n### 地區\n\n```{r }\ntemp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') -> temp_0812\ntemp_0812 %>% filter(is.na(area.x)!=TRUE) %>% filter(is.na(area.y)!=TRUE) %>% group_by(area.x,area.y)%>% summarise(人數=length(PRSN_ID)) %>% spread(area.x,人數,0) %>% gather(area.x,人數,2:6) -> temp_nlog\ntemp_0812 %>% filter(is.na(area.x)!=TRUE) %>% filter(is.na(area.y)!=TRUE) %>% group_by(area.x,area.y)%>% summarise(log_人數=log(length(PRSN_ID))) %>% spread(area.x,log_人數,0) %>% gather(area.x,log_人數,2:6) -> temp_log\ncolnames(temp_nlog)[1:2]=c('area_08','area_12')\ncolnames(temp_log)[1:2]=c('area_08','area_12')\ntemp_nlog %>% left_join(temp_log,by=c(\"area_08\",\"area_12\")) -> temp_0812\ntemp_0812$area_08=factor(temp_0812$area_08,levels=c(\"北部地區\",\"中部地區\",\"南部地區\",\"東部地區\",\"離島地區\"))\ntemp_0812$area_12=factor(temp_0812$area_12,levels=c(\"北部地區\",\"中部地區\",\"南部地區\",\"東部地區\",\"離島地區\"))\ntemp_0812 %>% ggplot(aes(area_08,area_12)) +geom_tile(aes(fill = log_人數)) +theme_bw(base_family=\"STHeiti\")+geom_text(aes( label = 人數))+\n    scale_fill_gradient(low = \"white\", high = \"#0D55B3\") +labs(title =\"護理人員2008年至2012年遷移人數\", x = \"各地區2008年\", y = \"各地區2012年\")+scale_alpha_continuous(name='pongpong')\n\n```\n\n### 縣市\n\n```{r }\ntemp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') -> temp_0812\ntemp_0812 %>% filter(is.na(縣市.x)!=TRUE) %>% filter(is.na(縣市.y)!=TRUE) %>% group_by(縣市.x,縣市.y)%>% summarise(人數=length(PRSN_ID)) %>% spread(縣市.x,人數,0) %>% gather(縣市.x,人數,2:23) -> temp_nlog\ntemp_0812 %>% filter(is.na(縣市.x)!=TRUE) %>% filter(is.na(縣市.y)!=TRUE) %>% group_by(縣市.x,縣市.y)%>% summarise(log_人數=log(length(PRSN_ID))) %>% spread(縣市.x,log_人數,0) %>% gather(縣市.x,log_人數,2:23) -> temp_log\ncolnames(temp_nlog)[1:2]=c('dis_08','dis_12')\ncolnames(temp_log)[1:2]=c('dis_08','dis_12')\ntemp_nlog %>% left_join(temp_log,by=c(\"dis_08\",\"dis_12\")) -> temp_0812\ntemp_0812 %>% filter(dis_08!=\"\") %>% filter(dis_12!=\"\") %>% as.data.frame() -> temp_0812\ntemp_0812$dis_08=factor(temp_0812$dis_08,levels=c(\"台北市\",\"新北市\",\"桃園市\",\"宜蘭縣\",,\"新竹市\",\"苗栗縣\",\"台中市\",\"南投縣\",\"彰化縣\",\"雲林縣\",\"嘉義縣\",\"嘉義市\",\"台南市\",\"高雄市\",\"屏東縣\",\"台東縣\",\"花蓮縣\",\"澎湖縣\",\"金門縣\",\"連江縣\"))\ntemp_0812$dis_12=factor(temp_0812$dis_12,levels=c(\"台北市\",\"新北市\",\"桃園市\",\"宜蘭縣\",\"基隆市\",\"新竹市\",\"苗栗縣\",\"台中市\",\"南投縣\",\"彰化縣\",\"雲林縣\",\"嘉義縣\",\"嘉義市\",\"台南市\",\"高雄市\",\"屏東縣\",\"台東縣\",\"花蓮縣\",\"澎湖縣\",\"金門縣\",\"連江縣\"))\ntemp_0812 %>% ggplot(aes(dis_08,dis_12)) +geom_tile(aes(fill = log_人數)) +theme_bw(base_family=\"STHeiti\")+geom_text(aes( label = 人數))+\n    scale_fill_gradient(low = \"white\", high = \"#0D55B3\") +labs(title =\"護理人員2008年至2012年遷移人數\", x = \"各縣市2008年\", y = \"各縣市2012年\")+theme(axis.text.x=element_text(angle =30 ,size=10))\n\n#temp %>% filter(year==\"2008\") %>% left_join(temp %>% filter(year==\"2012\"),by='PRSN_ID') -> temp_0812\n#temp_0812 %>% filter(is.na(縣市.x)!=TRUE) %>% filter(is.na(縣市.y)!=TRUE) %>% group_by(縣市.x,縣市.y) %>% summarise(log_人數=log(length(PRSN_ID))) %>% spread(縣市.x,log_人數,3) %>% gather(縣市.x,log_人數,2:23) %>% ggplot(aes(縣市.x,縣市.y)) +geom_tile(aes(fill = log_人數)) +theme_bw(base_family=\"STHeiti\")+geom_text(aes(fill = log_人數, label = round(log_人數)))+\n#    scale_fill_gradient(low = \"white\", high = \"#3322F0\") \n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
    "created" : 1466564630221.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "765952503",
    "id" : "969C3423",
    "lastKnownWriteTime" : 1466479853,
    "last_content_update" : 1466479853,
    "path" : "/Volumes/SD-Lofu/咪聽紀錄資料/論文專用/20160613meeting.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 9,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}