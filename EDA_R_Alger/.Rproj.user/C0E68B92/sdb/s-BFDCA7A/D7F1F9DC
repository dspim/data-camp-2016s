{
    "collab_server" : "",
    "contents" : "---\ntitle: \"20160620meeeting\"\nauthor: \"Chung Fu,Yang\"\ndate: \"2016年6月17日\"\noutput: \n  html_document:\n    theme: united\n    fig_width: 10\n    fig_height: 7.5\n    toc : true\n    toc_float:\n      collapsed: false\n      smooth_scroll: false\n---\n\n```{r,echo=FALSE,,warning=FALSE,message=F,plotly=TRUE}\noptions('scipen'=100,'digits'=8)\nknitr::opts_chunk$set(comment=\"\",prompt=T,strip.white=F,warning=FALSE,message=F,echo=F,out.width ='750px',out.height = '750px') #fig.width = X\nlibrary(formattable)\nlibrary(highcharter)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(ggmap)\nlibrary(data.table)\nlibrary(devtools)\nlibrary(DT)\nlibrary(RColorBrewer)\nlibrary(stringr)\nlibrary(data.table)\nlibrary(rgeos)\nlibrary(maptools)\nlibrary(RCurl)\nlibrary(grid)\nlibrary(rgdal)\nlibrary(RJDBC)\nlibrary(cowplot)\nlibrary(tidyr)\ntheme_clean <- function(base_size = 12) { \n  require(grid) # Needed for unit() function\n  theme_grey(base_size) %+replace%\ntheme(\n  axis.title = element_blank(),\n  axis.text = element_blank(), \n  panel.background = element_blank(),\n  panel.grid = element_blank(), \n  axis.ticks.length = unit(0, \"cm\"), \n  axis.ticks.margin = unit(0, \"cm\"),\n  panel.margin = unit(0, \"lines\"), \n  plot.margin = unit(c(0, 0, 0, 0), \"lines\"), \n  complete = TRUE) }\n###############\n  multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {\n    library(grid)\n    \n    # Make a list from the ... arguments and plotlist\n    plots <- c(list(...), plotlist)\n    \n    numPlots = length(plots)\n    \n    # If layout is NULL, then use 'cols' to determine layout\n    if (is.null(layout)) {\n      # Make the panel\n      # ncol: Number of columns of plots\n      # nrow: Number of rows needed, calculated from # of cols\n      layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),\n                       ncol = cols, nrow = ceiling(numPlots/cols))\n    }\n    \n    if (numPlots==1) {\n      print(plots[[1]])\n      \n    } else {\n      # Set up the page\n      grid.newpage()\n      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))\n      \n      # Make each plot, in the correct location\n      for (i in 1:numPlots) {\n        # Get the i,j matrix positions of the regions that contain this subplot\n        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))\n        \n        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,\n                                        layout.pos.col = matchidx$col))\n      }\n    }\n  }\n科別 = read.csv(\"科別欄位專用.csv\",header = T,fileEncoding = 'big5')\n## 用R載入JDBC的驅動程式，讓我們可以透過第三方驅動程式連線至SQL Server\ndrv <- JDBC(\"com.microsoft.sqlserver.jdbc.SQLServerDriver\",\n\t\t\"/Users/apple/Downloads/sqljdbc_4.2/cht/sqljdbc42.jar\")\n## 登入112的伺服器 打使用者帳號與密碼\ncon <- dbConnect(drv,\n\t\t\tpaste0(\"jdbc:sqlserver://\", '140.119.80.112:1435'),\n\t\t\t'test', 'aaa')\n# 各地區熱圖遷移率\n# 各地區遷移還有將遷移轉成比例\n# 醫師護士比較\n# 2008NA~2012NA也許是暫時休息\n## 讀檔與資料命名\ntemp = read.csv(\"PHN.csv\",header=T)\ntemp$year = as.factor(temp$year)\ntemp %>% mutate(PRSN_SEX=gsub(\"F   \",\"F\",temp$PRSN_SEX)) -> temp\ntemp %>% mutate(PRSN_SEX=gsub(\"M   \",\"M\",temp$PRSN_SEX)) -> temp\ncolnames(temp)[14:16]=c(\"五齡組_old\",\"area\",\"五齡組_new\")\n```\n\n## 問題總覽：\n\n### 明星醫師的議題！\n\n* 關於不同看診次數下的醫師人數，使用下面的機率密度分佈圖來表示各個不同地區的分佈是不是正確？\n* 因為X軸為看診人次，但不管是哪個區域的醫師人數多分佈於看診人次少於500的階段，這是不是有問題？\n\n*** \n\n由此圖型明顯可看出東部與離島地區的小兒科醫師，其看診人次分佈多集中於500次以下，而六都及其他地區則多分佈較為廣泛，在500次～1500次為主要醫師分佈區段，但可發現仍有少數醫師集中於看診次數2000次以上，尤其以東部及離島地區較為明顯，是否能合理懷疑可能有少數醫師其看診次數極高，而存在著病人都找明星醫師的現象？！\n\n*** \n\n\n```{r}\ntemp = read.csv(\"醫師看診次數2005.csv\",header = F,fileEncoding = 'big5')\ncolnames(temp) = c(\"id\",\"PRSN_ID\",\"縣市\",\"就診人次\")\ncolnames(temp)[1] = 'id'\ncolnames(科別)[1] = 'id'\ntemp %>% left_join(科別,by='id') %>% select(2,5,3,4) -> temp\ntemp %>% mutate(科別=gsub(\" \",\"\",temp$科別)) -> temp\n#### 六都  ####\ntemp %>% filter(縣市==\"台北市\"|縣市==\"新北市\"|縣市==\"桃園市\"|縣市==\"台中市\"|縣市==\"台南市\"|縣市==\"高雄市\") %>% arrange(就診人次) %>% filter(科別==\"小兒科\") %>% group_by(就診人次) %>% summarise(醫師數=length(PRSN_ID)) %>% mutate(區域='六都')-> temp1\n#### 東部離島  ####\ntemp %>% filter(縣市==\"澎湖縣\"|縣市==\"金門縣\"|縣市==\"連江縣\"|縣市==\"台東縣\"|縣市==\"花蓮縣\") %>% arrange(就診人次) %>% filter(科別==\"小兒科\") %>% group_by(就診人次) %>% summarise(醫師數=length(PRSN_ID)) %>% mutate(區域='東部與離島')-> temp2\n#### 非東部離島非六都  ####\ntemp %>% filter(縣市!=\"台北市\"&縣市!=\"新北市\"&縣市!=\"桃園市\"&縣市!=\"台中市\"&縣市!=\"台南市\"&縣市!=\"高雄市\"&縣市!=\"澎湖縣\"&縣市!=\"金門縣\"&縣市!=\"連江縣\"&縣市!=\"台東縣\"&縣市!=\"花蓮縣\") %>% arrange(就診人次) %>% filter(科別==\"小兒科\") %>% group_by(就診人次) %>% summarise(醫師數=length(PRSN_ID)) %>% mutate(區域='非六都非東部離島')-> temp3\ntemp1 %>% bind_rows(temp2) %>% bind_rows(temp3) %>% ggplot(aes(x=就診人次,y=..density..,fill=區域))+geom_density(position = 'identity',alpha=.2)+theme_bw(base_family=\"STHeiti\")+ coord_cartesian(xlim = c(0, 2500))+labs(title =\"小兒科在各區域不同看診人次的醫師人數機率密度分佈圖\", x = \"看診人次\")\n```\n\n### 各縣市是否存在明星醫師的界定？\n\n* 以各縣市的醫師平均看診量跟每位醫師的看診次數變異程度來判斷明星醫師的現象\n* 目前遇到問題是看診次數的解釋，例如由圖中可看出宜蘭縣醫師的平均看診量為498次，但是實際上一年內醫師不可能只看498次，所以想問問老師？！\n* 我目前使用全台灣小兒科醫師平均看診次數作為基準判定。\n\n```{r}\ndbGetQuery(con,'select func_type,prsn_id,縣市,count(id) as 就診人次 from 小0_HOSB練習資料庫.dbo.常駐CDHP2005 group by func_type,prsn_id,縣市 ') -> temp\ncolnames(temp)[1] = 'id'\ncolnames(科別)[1] = 'id'\ntemp %>% left_join(科別,by='id') %>% select(2,5,3,4) -> temp\ntemp %>% mutate(科別=gsub(\" \",\"\",temp$科別)) -> temp\ntemp %>% filter(科別==\"小兒科\") %>% group_by(縣市) %>% summarise(就診人次=round(mean(就診人次))) -> temp1\ntemp %>% filter(科別==\"小兒科\") %>% group_by(縣市) %>% summarise(就診人次=round(sd(就診人次))) -> temp2\ncolnames(temp1)=c(\"id\",\"平均看診量\")\ncolnames(temp2)=c(\"id\",\"看診量標準差\")\n#temp2 %>% left_join(temp1,by='id') %>% gather(class,value,2:3) -> temp_t\n#temp_t$class = as.factor(temp_t$class)\n#temp_t$class = factor(temp_t$class,levels = c(\"平均看診量\",\"看診量標準差\"))\ntemp1 %>% ggplot(aes(x=reorder(id,desc(平均看診量)),y=平均看診量))+geom_bar(stat=\"identity\",position = 'dodge')+theme_bw(base_family=\"STHeiti\")+scale_fill_brewer(palette =\"Set1\")+labs(title =\"各縣市小兒科醫師看診量的平均數\", x = \"縣市\", y = \"次數\")+theme(axis.text.x=element_text(angle =45 ,size=10),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=20),plot.title = element_text(size = rel(1.5)))+geom_hline(aes(yintercept=200),colour = \"red\",linetype = \"dashed\", size = 0.8)+geom_text(aes(label = 平均看診量, x = id, y =平均看診量), position = position_dodge(width = 0.8), vjust = -0.6)+ coord_cartesian(ylim = c(0,800))+ annotate(\"text\", x =10, y =240, label =\"全國小兒科醫師平均看診量\",family=\"STHeiti\", colour = \"red\",size=5.5) -> a\n\n\ntemp2$id = factor(temp2$id,levels=c(\"宜蘭縣\",\"新竹縣\",\"新北市\",\"彰化縣\",\"台南市\",\"南投縣\",\"新竹市\",\"嘉義市\",\"台中市\",\"苗栗縣\",\"雲林縣\",\"桃園市\",\"澎湖縣\",\"高雄市\",\"金門縣\",\"台東縣\",\"屏東縣\",\"台北市\",\"基隆市\",\"花蓮縣\",\"嘉義縣\",\"連江縣\"))\ntemp2 %>% ggplot(aes(x=id,y=看診量標準差))+geom_bar(stat=\"identity\",position = 'dodge')+theme_bw(base_family=\"STHeiti\")+scale_fill_brewer(palette =\"Set1\")+labs(title =\"各縣市小兒科醫師看診量標準差\", x = \"縣市\", y = \"次數\")+theme(axis.text.x=element_text(angle =45 ,size=10),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=20),plot.title = element_text(size = rel(1.5)))+geom_text(aes(label = 看診量標準差, x = id, y =看診量標準差), position = position_dodge(width = 0.8), vjust = -0.6)+ coord_cartesian(ylim = c(0,800))-> b\n## \nplot_grid(a,b, ncol = 1, nrow = 2)\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
    "created" : 1466563612114.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4276245665",
    "id" : "D7F1F9DC",
    "lastKnownWriteTime" : 1466441539,
    "last_content_update" : 1466441539,
    "path" : "/Volumes/SD-Lofu/咪聽紀錄資料/論文專用/20160620meeting.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}